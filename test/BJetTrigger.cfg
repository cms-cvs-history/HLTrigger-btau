process test = {
 
    # input file
    source = PoolSource {
       # b-bbar jets
       untracked vstring fileNames = { '/store/RelVal/2006/12/16/RelVal120BJets50-120/0000/00D1599A-578D-DB11-8741-001731AF68C7.root' }
       untracked int32   maxEvents = 100
    }

    # Enable debug printout from HLT modules.
    service = MessageLogger {
       untracked vstring destinations = { "cout" }
       untracked PSet cout        = { untracked string threshold = "DEBUG" }
       untracked vstring debugModules = { "highestEtJets", "etCutJets", "regionalCtfWithMaterialTracks", "hltL25b", "hltL3b" }
    }

    #
    # General event reconstruction
    #

    #
    # Select jets used for regional tracking and considered for b tagging
    #

    module highestEtJets = LargestEtCaloJetSelector {
      InputTag src = iterativeCone5CaloJets 
      bool filter = false
      uint32 maxNumber = 2  # Take only 2 highest Et jets
    }
    module etCutJets = EtMinCaloJetSelector {
      InputTag src = highestEtJets 
      bool filter = false
      double etMin = 20.0  # And require jet Et greater than cut.
    }

    #
    #   Pixel primary vertices and tracks (used at L2.5 and L3)
    #
    include "TrackingTools/TransientTrack/data/TransientTrackBuilder.cfi" 
    include "RecoPixelVertexing/PixelTrackFitting/data/PixelTracks.cff"
    include "RecoPixelVertexing/PixelVertexFinding/data/PixelVertexes.cff"  
    #
    #   Regional tracking around etCutJets (used at L3).
    #
    include "HLTrigger/HLTstaging/data/jetTag/regionalTracking.cff"
    replace regionalPixelSeedGenerator.JetSrc = etCutJets

    #
    # Additional b tag reconstruction needed for L2.5 b HLT.
    #

    module associatorL25 = jetTracksAssociator from "RecoBTau/JetTracksAssociator/data/jetTracksAssociator.cfi"
    replace associatorL25.tracks = pixelTracks
    replace associatorL25.jets   = etCutJets # Take jets from previous selection

    module trackCountingJetTagsL25 = trackCountingJetTags from "RecoBTag/TrackCounting/data/trackCounting.cfi"
    replace trackCountingJetTagsL25.jetTracks = "associatorL25"
    replace trackCountingJetTagsL25.primaryVertex = "pixelVertices" 
    replace trackCountingJetTagsL25.AlgorithmPSet.NthTrack = 2 
    replace trackCountingJetTagsL25.AlgorithmPSet.ImpactParamterType = 0   # Use 3D impact parameter.  
    replace trackCountingJetTagsL25.AlgorithmPSet.MinimumNumberOfHits = 3  # (Pixel tracks only have 3 hits ...)

    #
    # Additional b tag reconstruction needed for L3 b HLT.
    #

    module associatorL3 = jetTracksAssociator from "RecoBTau/JetTracksAssociator/data/jetTracksAssociator.cfi"
    replace associatorL3.tracks = regionalCtfWithMaterialTracks
    replace associatorL3.jets   = etCutJets # Take jets from previous selection

    module trackCountingJetTagsL3 = trackCountingJetTags from "RecoBTag/TrackCounting/data/trackCounting.cfi"
    replace trackCountingJetTagsL3.jetTracks = "associatorL3"
    replace trackCountingJetTagsL3.primaryVertex = "pixelVertices" 
    replace trackCountingJetTagsL3.AlgorithmPSet.NthTrack = 3 
    replace trackCountingJetTagsL3.AlgorithmPSet.ImpactParamterType = 0   # Use 3D impact parameter
    replace trackCountingJetTagsL3.AlgorithmPSet.MinimumNumberOfHits = 8  # (Partially reconstructed tracks don't have many hits ...)

    #
    # Trigger modules for Level 2.5 and 3.
    #

    module hltL25b = hltJetTag from "HLTrigger/HLTstaging/data/jetTag/hltJetTag.cfi"
    replace hltL25b.JetTag = trackCountingJetTagsL25
    replace hltL25b.MinTag = 2.5

    module hltL3b = hltJetTag from "HLTrigger/HLTstaging/data/jetTag/hltJetTag.cfi"
    replace hltL3b.JetTag = trackCountingJetTagsL3
    replace hltL3b.MinTag = 3

    #
    # Event reconstruction needed for trigger.
    #

    sequence preL25bReco  = {highestEtJets, etCutJets,
                             pixelTracks, pixelVertices,
                             associatorL25, trackCountingJetTagsL25}

    sequence preL3bReco   = {regionalCkfTracks, 
                             associatorL3, trackCountingJetTagsL3}

    # Trigger path

    path p1 = {preL25bReco, hltL25b, 
               preL3bReco, hltL3b}

    # Write events passing trigger

    module out = PoolOutputModule {
      untracked string fileName = 'file:HLToutput.root'
      untracked PSet SelectEvents = {
        vstring SelectEvents = { "p1" }
      }
    }

    endpath outpath = { out }
}
